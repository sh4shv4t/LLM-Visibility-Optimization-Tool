<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900"> <!-- 1. REMOVE h-full from here -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local RAG Scraper</title>
    <!-- 1. Load Tailwind CSS for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
</head>
<!-- 2. MODIFY this line -->
<body class="flex justify-center p-4 py-12 bg-gray-900 text-gray-100 font-sans">

    <div class="w-full max-w-2xl bg-gray-800 rounded-lg shadow-xl p-6 space-y-8">
        
        <!-- === SECTION 1: SCRAPING === -->
        <div class="space-y-4">
            <h1 class="text-2xl font-bold text-center text-white">LLM Optimization Tool</h1>
            <p class="text-sm text-gray-400 text-center">
                Step 1: Scrape a website to create your local knowledge base.
            </p>
            
            <!-- This 'form' won't submit traditionally. We'll intercept it with JS. -->
            <form id="scrape-form" class="flex flex-col sm:flex-row gap-3">
                <input 
                    type="text" 
                    id="url-input" 
                    placeholder="Enter a full URL (e.g., https://...)" 
                    class="flex-1 p-3 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                >
                <button 
                    type="submit" 
                    id="scrape-button"
                    class="px-5 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed"
                >
                    <!-- This 'span' is for the button text -->
                    <span id="scrape-button-text">Scrape & Index</span>
                    <!-- This 'div' is a hidden loading spinner -->
                    <div id="scrape-loader" class="hidden w-5 h-5 border-2 border-t-transparent border-white rounded-full animate-spin mx-auto"></div>
                </button>
            </form>
            <p id="scrape-status" class="text-center text-green-400 h-5"></p>
        </div>

        <hr class="border-gray-700" />

        <!-- === SECTION 2: Q&A === -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-center text-white">Step 2: Ask a Question</h2>
            
            <!-- This 'div' is where the chat messages will appear -->
            <div id="chat-window" class="h-64 p-4 bg-gray-900 rounded-md border border-gray-700 overflow-y-auto space-y-3">
                <!-- Messages will be added here by JavaScript -->
                <div class="text-gray-400">Your conversation will appear here...</div>
            </div>

            <!-- This is the form for asking a question -->
            <form id="ask-form" class="flex gap-3">
                <input 
                    type="text" 
                    id="question-input" 
                    placeholder="Ask a question about the scraped content..." 
                    class="flex-1 p-3 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                >
                <button 
                    type="submit" 
                    id="ask-button"
                    class="px-5 py-3 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition-colors duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed"
                >
                    <!-- Button text -->
                    <span id="ask-button-text">Ask</span>
                    <!-- Loading spinner -->
                    <div id="ask-loader" class="hidden w-5 h-5 border-2 border-t-transparent border-white rounded-full animate-spin mx-auto"></div>
                </button>
            </form>
        </div>

        <!-- === NEW SECTION 3: ANALYSIS === -->
        <hr class="border-gray-700" />
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-center text-white">Step 3: Analyze Scrape Quality</h2>
            <p class="text-sm text-gray-400 text-center">
                Run a standard analysis to score the quality and completeness of the scraped data.
            </p>
            <div class="flex justify-center">
                <button 
                    id="analyze-button"
                    class="px-5 py-3 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-700 transition-colors duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed"
                >
                    <!-- Button text -->
                    <span id="analyze-button-text">Run Scrape Analysis</span>
                    <!-- Loading spinner -->
                    <div id="analyze-loader" class="hidden w-5 h-5 border-2 border-t-transparent border-white rounded-full animate-spin mx-auto"></div>
                </button>
            </div>
            
            <!-- This 'div' is where the analysis report will appear -->
            <div id="analysis-results" class="mt-4 p-4 bg-gray-900 rounded-md border border-gray-700 space-y-3 hidden">
                <!-- Analysis report will be injected here by JavaScript -->
            </div>
        </div>
        <!-- === END NEW SECTION === -->

    </div>

    <!-- === JAVASCRIPT LOGIC === -->
    <!-- This is the "frontend" logic that talks to your Python "backend" -->
    <script>
        // Get references to all our important HTML elements
        const scrapeForm = document.getElementById('scrape-form');
        const urlInput = document.getElementById('url-input');
        const scrapeButton = document.getElementById('scrape-button');
        const scrapeButtonText = document.getElementById('scrape-button-text');
        const scrapeLoader = document.getElementById('scrape-loader');
        const scrapeStatus = document.getElementById('scrape-status');

        const askForm = document.getElementById('ask-form');
        const questionInput = document.getElementById('question-input');
        const askButton = document.getElementById('ask-button');
        const askButtonText = document.getElementById('ask-button-text');
        const askLoader = document.getElementById('ask-loader');
        const chatWindow = document.getElementById('chat-window');

        // --- NEW: Get references for Analysis elements ---
        const analyzeButton = document.getElementById('analyze-button');
        const analyzeButtonText = document.getElementById('analyze-button-text');
        const analyzeLoader = document.getElementById('analyze-loader');
        const analysisResults = document.getElementById('analysis-results');


        // Clear the chat window on page load
        chatWindow.innerHTML = '';

        // --- Handle the Scrape & Index action ---
        scrapeForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Stop the form from refreshing the page
            
            const url = urlInput.value;
            if (!url) return;

            // --- UI: Show loading state ---
            scrapeStatus.textContent = 'Scraping and indexing... this may take a moment.';
            scrapeButton.disabled = true;
            scrapeButtonText.classList.add('hidden');
            scrapeLoader.classList.remove('hidden');

            try {
                // --- What is `fetch`? ---
                // This is the "frontend" talking to the "backend".
                // We send a POST request to our '/scrape' route (in app.py)
                const response = await fetch('/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // Tell the server we're sending JSON
                    },
                    // `JSON.stringify` converts a JavaScript object to a JSON string
                    body: JSON.stringify({ url: url }),
                });

                const result = await response.json(); // Read the JSON response from the server

                if (!response.ok) {
                    // If the server sent an error (like 500), throw an error
                    throw new Error(result.error || 'Unknown error occurred');
                }
                
                // --- UI: Show success ---
                scrapeStatus.textContent = result.message; // Show success message from server
                urlInput.value = ''; // Clear the input

            } catch (error) {
                // --- UI: Show error ---
                scrapeStatus.textContent = `Error: ${error.message}`;
                scrapeStatus.classList.remove('text-green-400');
                scrapeStatus.classList.add('text-red-400');
            } finally {
                // --- UI: Reset button ---
                // This 'finally' block runs whether it succeeded or failed
                scrapeButton.disabled = false;
                scrapeButtonText.classList.remove('hidden');
                scrapeLoader.classList.add('hidden');
            }
        });

        // --- Handle the Ask Question action ---
        askForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = questionInput.value;
            if (!question) return;

            // --- UI: Add user's question to chat ---
            addMessageToChat(question, 'user');
            questionInput.value = ''; // Clear the input

            // --- UI: Show loading state ---
            askButton.disabled = true;
            askButtonText.classList.add('hidden');
            askLoader.classList.remove('hidden');

            try {
                // --- Talk to the backend! ---
                // Send a POST request to our '/ask' route (in app.py)
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question }),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Unknown error occurred');
                }
                
                // --- UI: Add bot's answer to chat ---
                addMessageToChat(result.answer, 'bot');

            } catch (error) {
                // --- UI: Add error message to chat ---
                addMessageToChat(`Error: ${error.message}`, 'bot');
            } finally {
                // --- UI: Reset button ---
                askButton.disabled = false;
                askButtonText.classList.remove('hidden');
                askLoader.classList.add('hidden');
            }
        });

        // --- NEW: Handle the Analyze Scrape action with SSE ---
        analyzeButton.addEventListener('click', async () => {
            // --- UI: Show loading state ---
            analysisResults.classList.remove('hidden');
            analysisResults.innerHTML = '<div id="progress-log" class="text-sm font-mono space-y-1"></div>';
            analyzeButton.disabled = true;
            analyzeButtonText.textContent = 'Analyzing...';
            analyzeButtonText.classList.remove('hidden');
            analyzeLoader.classList.add('hidden');

            const progressLog = document.getElementById('progress-log');

            try {
                // Start the analysis
                const startResponse = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });

                if (!startResponse.ok) {
                    const error = await startResponse.json();
                    throw new Error(error.error || 'Failed to start analysis');
                }

                // Connect to SSE stream for progress updates
                const eventSource = new EventSource('/analyze/stream');
                
                eventSource.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    
                    // Display progress message
                    if (msg.message && msg.message !== 'COMPLETE' && msg.message !== 'ERROR') {
                        const progressLine = document.createElement('div');
                        progressLine.className = 'text-gray-300';
                        progressLine.textContent = msg.message;
                        progressLog.appendChild(progressLine);
                        progressLog.scrollTop = progressLog.scrollHeight;
                    }
                    
                    // Handle completion
                    if (msg.message === 'COMPLETE') {
                        eventSource.close();
                        
                        // Add completion banner to progress log
                        const completionBanner = document.createElement('div');
                        completionBanner.className = 'mt-4 p-4 bg-green-900 bg-opacity-30 border-2 border-green-500 rounded-lg';
                        completionBanner.innerHTML = `
                            <div class="text-center">
                                <div class="text-2xl mb-2">üéâ</div>
                                <div class="text-lg font-bold text-green-400">Analysis Complete!</div>
                                <div class="text-sm text-gray-300 mt-2">Overall GEO Score: <span class="font-bold">${msg.data.report.overall_geo_score}/100</span></div>
                                <div class="text-sm text-gray-300">Answer Rate: <span class="font-bold">${(msg.data.report.statistics.answer_rate * 100).toFixed(1)}%</span></div>
                                <div class="text-xs text-gray-400 mt-1">${msg.data.report.rating_description || ''}</div>
                            </div>
                        `;
                        progressLog.appendChild(completionBanner);
                        progressLog.scrollTop = progressLog.scrollHeight;
                        
                        // Display full report below
                        displayAnalysisReport(msg.data.report);
                        analyzeButton.disabled = false;
                        analyzeButtonText.textContent = 'Run Scrape Analysis';
                    }
                    
                    // Handle error
                    if (msg.message === 'ERROR') {
                        eventSource.close();
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'text-red-400 mt-2';
                        errorDiv.textContent = `Error: ${msg.data.error}`;
                        progressLog.appendChild(errorDiv);
                        analyzeButton.disabled = false;
                        analyzeButtonText.textContent = 'Run Scrape Analysis';
                    }
                };

                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'text-red-400 mt-2';
                    errorDiv.textContent = 'Connection error. Please try again.';
                    progressLog.appendChild(errorDiv);
                    analyzeButton.disabled = false;
                    analyzeButtonText.textContent = 'Run Scrape Analysis';
                };

            } catch (error) {
                displayAnalysisReport({ error: error.message });
                analyzeButton.disabled = false;
                analyzeButtonText.textContent = 'Run Scrape Analysis';
            }
        });

        // --- NEW: Helper function to display the comprehensive analysis report ---
        function displayAnalysisReport(report) {
            if (report.error) {
                const errorHTML = `<p class="text-red-400">Error: ${report.error}</p>`;
                analysisResults.innerHTML += errorHTML;
                return;
            }

            // Add separator before detailed report
            let reportHTML = `
                <div class="my-6 border-t-2 border-gray-700"></div>
                <h2 class="text-2xl font-bold text-white mb-4">üìä Detailed Analysis Report</h2>
                <div class="space-y-6">
            `;

            // 1. Overall GEO Score (prominent display)
            if (report.overall_geo_score !== undefined) {
                const score = report.overall_geo_score;
                const rating = report.rating || 'N/A';
                let scoreColor = 'text-red-400';
                if (score >= 75) scoreColor = 'text-green-400';
                else if (score >= 50) scoreColor = 'text-yellow-400';
                else if (score >= 25) scoreColor = 'text-orange-400';
                
                reportHTML += `
                    <div class="text-center p-6 bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg border border-gray-700">
                        <div class="text-sm text-gray-400 uppercase tracking-wide mb-2">Overall GEO Score</div>
                        <div class="${scoreColor} text-6xl font-bold mb-2">${score}<span class="text-3xl">/100</span></div>
                        <div class="text-xl text-gray-300 uppercase tracking-wider">${rating}</div>
                        ${report.rating_description ? `<p class="text-sm text-gray-400 mt-2">${report.rating_description}</p>` : ''}
                    </div>
                `;
            }

            // 2. Statistics
            if (report.statistics) {
                const stats = report.statistics;
                const answerRate = ((stats.answer_rate || 0) * 100).toFixed(1);
                
                reportHTML += `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-gray-800 rounded-lg">
                            <div class="text-sm text-gray-400">Answer Rate</div>
                            <div class="text-2xl font-bold text-blue-400">${answerRate}%</div>
                            <div class="text-xs text-gray-500">${stats.answered_questions}/${stats.total_questions} questions</div>
                        </div>
                        <div class="p-4 bg-gray-800 rounded-lg">
                            <div class="text-sm text-gray-400">Avg LLM Confidence</div>
                            <div class="text-2xl font-bold text-green-400">${stats.avg_llm_confidence.toFixed(1)}<span class="text-sm">/10</span></div>
                        </div>
                    </div>
                `;
            }

            // 3. Dimension Scores
            if (report.dimension_scores) {
                reportHTML += `
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-3">Dimension Breakdown</h3>
                        <div class="space-y-2">
                `;
                
                for (const [dimension, score] of Object.entries(report.dimension_scores)) {
                    const percentage = Math.min(100, Math.max(0, score));
                    let barColor = 'bg-red-500';
                    if (percentage >= 75) barColor = 'bg-green-500';
                    else if (percentage >= 50) barColor = 'bg-yellow-500';
                    else if (percentage >= 25) barColor = 'bg-orange-500';
                    
                    reportHTML += `
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-300 capitalize">${dimension}</span>
                                <span class="text-gray-400">${score.toFixed(1)}/100</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="${barColor} h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }
                
                reportHTML += '</div></div>';
            }

            // 4. Top Recommendations
            if (report.recommendations) {
                const recs = report.recommendations;
                if (recs.critical && recs.critical.length > 0) {
                    reportHTML += `
                        <div class="bg-red-900 bg-opacity-20 border border-red-700 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-red-400 mb-2">üö® Critical Improvements</h3>
                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-300">
                    `;
                    recs.critical.slice(0, 5).forEach(rec => {
                        reportHTML += `<li>${rec}</li>`;
                    });
                    reportHTML += '</ul></div>';
                }
                
                if (recs.important && recs.important.length > 0) {
                    reportHTML += `
                        <div class="bg-yellow-900 bg-opacity-20 border border-yellow-700 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-yellow-400 mb-2">‚ö†Ô∏è Important Improvements</h3>
                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-300">
                    `;
                    recs.important.slice(0, 5).forEach(rec => {
                        reportHTML += `<li>${rec}</li>`;
                    });
                    reportHTML += '</ul></div>';
                }
            }

            reportHTML += '</div></div>';
            analysisResults.innerHTML += reportHTML;
        }


        // --- Helper function to add messages to the chat window ---
        function addMessageToChat(text, sender) {
            const messageDiv = document.createElement('div');
            let bgColor = 'bg-blue-600'; // Bot color
            let align = 'self-start';     // Bot alignment

            if (sender === 'user') {
                bgColor = 'bg-gray-600';  // User color
                align = 'self-end';       // User alignment
            }
            
            // Use Tailwind classes to style the new message
            messageDiv.className = `p-3 rounded-lg max-w-xs ${bgColor} ${align}`;
            
            // We use .innerText to safely add the text, preventing HTML injection
            messageDiv.innerText = text; 
            
            chatWindow.appendChild(messageDiv);
            
            // Auto-scroll to the bottom
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    </script>
</body>
</html>